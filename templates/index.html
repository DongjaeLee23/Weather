<!DOCTYPE html>
<html>
<head>
    <title>Weather App</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
<h1>Weather App</h1>

<form id="weather-form" autocomplete="off">
    <label for="city">City:</label>
    <input type="hidden" id="lat" name="lat">
    <input type="hidden" id="lon" name="lon">
    <div class="autocomplete-wrapper" style="position: relative; width: 300px;">
        <input type="text" id="city" name="city" required>
        <div id="suggestions"></div>
    </div>

    <label for="units">Units:</label>
    <select name="units" id="units">
        <option value="metric">Metric (°C)</option>
        <option value="imperial" selected>Imperial (°F)</option>
    </select>

    <button type="submit">Get Weather</button>
</form>

<div id="weather-container" class="weather-wrapper">
    <div id="current"></div>
    <div id="hourly-forecast" class="hourly-scroll"></div>
    <div id="forecast"></div>
    <p id="error-msg" style="color:red;"></p>
</div>

<script>
const cityInput = document.getElementById("city");
const latInput = document.getElementById("lat");
const lonInput = document.getElementById("lon");
const suggestionsDiv = document.getElementById("suggestions");
const form = document.getElementById("weather-form");
let debounceTimeout;

// --- Fetch weather and render ---
async function getWeather(lat, lon) {
    if (!lat || !lon) return;

    const units = document.getElementById("units")?.value || "imperial";
    const tempUnit = units === "imperial" ? "°F" : "°C";
    const windUnit = units === "imperial" ? "mph" : "kph";

    try {
        const response = await fetch(`/weather?lat=${lat}&lon=${lon}&units=${units}`);
        const data = await response.json();

        if (data.error) {
            document.getElementById("error-msg").textContent = data.error;
            document.getElementById("current").innerHTML = "";
            document.getElementById("forecast").innerHTML = "";
            return;
        }

        document.getElementById("error-msg").textContent = "";

        // --- Current Weather ---
        const current = data.current;
        const location = `${data.location.name}, ${data.location.region}, ${data.location.country}`;
        const temp = current.temp;

        // Merge today and tomorrow hours
        const todayHours = data.forecast.forecastday[0].hour;
        const tomorrowHours = data.forecast.forecastday[1]?.hour || [];
        const allHours = todayHours.concat(tomorrowHours);

        // Take next 12 hours
        const nowHour = new Date().getHours();
        const next12Hours = allHours.slice(nowHour, nowHour + 12);

        // Build hourly HTML
        let hourlyHTML = `<div class="hourly-scroll">`;
        next12Hours.forEach(hour => {
            const time = new Date(hour.time).toLocaleTimeString([], { hour: "numeric" });
            const tempHour = units === "imperial" ? hour.temp_f : hour.temp_c;
            const icon = `https:${hour.condition.icon}`;

            hourlyHTML += `
                <div class="hour-card">
                    <p>${time}</p>
                    <img src="${icon}" alt="${hour.condition.text}">
                    <p>${tempHour}°</p>
                </div>
            `;
        });
        hourlyHTML += `</div>`;

        // Render current weather + hourly scroll
        document.getElementById("current").innerHTML = `
            <h2>Weather in<br>${location}</h2>
            <p>${temp}${tempUnit} - ${current.condition.text}</p>
            <p>Humidity: ${current.humidity}%</p>
            <p>Wind: ${units === "imperial" ? current.wind_mph : current.wind_kph} ${windUnit}</p>
            ${hourlyHTML}
        `;
        // <img src="https:${current.condition.icon}" alt="Weather Icon">




        // --- 7-Day Forecast ---
        let forecastHTML = "<h2>7-Day Forecast</h2><div class='forecast-grid'>";
        data.forecast.forecastday.forEach(day => {
            const date = new Date(day.date);
            const dayTemp = day.day.avgtemp;
            forecastHTML += `
                <div class="forecast-day">
                    <h3>${date.toDateString()}</h3>
                    <p>Avg Temp: ${dayTemp}${tempUnit}</p>
                    <p>${day.day.condition.text}</p>
                    <img src="https:${day.day.condition.icon}" alt="Weather Icon">
                </div>
            `;
        });
        forecastHTML += "</div>";
        document.getElementById("forecast").innerHTML = forecastHTML;

    } catch (err) {
        console.log(err)
        document.getElementById("error-msg").textContent = "Failed to fetch weather data.";
        document.getElementById("current").innerHTML = "";
        document.getElementById("forecast").innerHTML = "";
    }
}


// --- Autocomplete ---
cityInput.addEventListener("input", function () {
    const query = this.value.trim();
    suggestionsDiv.innerHTML = "";
    latInput.value = "";
    lonInput.value = "";

    if (!query) return;

    clearTimeout(debounceTimeout);
    debounceTimeout = setTimeout(() => {
        fetch(`/autocomplete?q=${encodeURIComponent(query)}`)
            .then(res => res.json())
            .then(data => {
                data.forEach(city => {
                    const div = document.createElement("div");
                    div.textContent = city.label;
                    div.style.padding = "5px";
                    div.style.cursor = "pointer";

                    div.addEventListener("click", () => {
                        cityInput.value = city.label;
                        latInput.value = city.lat;
                        lonInput.value = city.lon;
                        suggestionsDiv.innerHTML = "";
                    });

                    suggestionsDiv.appendChild(div);
                });
            });
    }, 300);
});

document.addEventListener("click", function (e) {
    if (e.target !== cityInput) suggestionsDiv.innerHTML = "";
});

// --- Handle form submit ---
form.addEventListener("submit", function (e) {
    e.preventDefault();

    // If lat/lon already set (clicked suggestion)
    if (latInput.value && lonInput.value) {
        getWeather(latInput.value, lonInput.value);
    } else {
        // Resolve city via autocomplete API
        const query = cityInput.value.trim();
        if (!query) return;

        fetch(`/autocomplete?q=${encodeURIComponent(query)}`)
            .then(res => res.json())
            .then(data => {
                if (data.length > 0) {
                    const city = data[0];  // first match
                    latInput.value = city.lat;
                    lonInput.value = city.lon;
                    getWeather(city.lat, city.lon);
                } else {
                    document.getElementById("error-msg").textContent = "City not found.";
                }
            });
    }
});

// --- Geolocation on page load ---
window.onload = function () {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            pos => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                latInput.value = lat;
                lonInput.value = lon;
                getWeather(lat, lon);
            },
            err => console.log("Geolocation denied:", err)
        );
    }
};
</script>
